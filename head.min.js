var rawDataObject={hideList:["filter","anchor","dslope"],pxGB:"GB Px",updateField:["Absolute grid Px","GB grid Px","Grid deviation"],anchorName:{x:"Anchor revenue",y:"Anchor Px"},dSlopeName:["DSlope"],capacityName:["Filter - Capacity"],userLogCount:0,userLog:"",minPriceX:1E6,margin:{top:50,right:150,bottom:50,left:50}};rawDataObject.width=1280-rawDataObject.margin.left-rawDataObject.margin.right;rawDataObject.height=800-rawDataObject.margin.top-rawDataObject.margin.bottom;
function sortNumber(a,b){return a-b}function log10(a){return Math.log(a)/Math.LN10}function extractValue(a,b){return a.map(function(a){return a[b]})}function findLine(a,b,c,d,e){var h=d-a*c,f={};f.x1=b;f.y1=a*b+h;f.x2=c;f.y2=d;f.slope=a;f.intercept=h;f.y2Max=h+e*a;return f}$(document).ready(function(){isAPIAvailable()&&$("#files").bind("change",handleFileSelect)});
function isAPIAvailable(){if(window.File&&window.FileReader&&window.FileList&&window.Blob)return!0;document.writeln("The HTML5 APIs used in this page are only available in the following browsers:<br/>");document.writeln(" - Google Chrome: 13.0 or later<br/>");document.writeln(" - Mozilla Firefox: 6.0 or later<br/>");document.writeln(" - Internet Explorer: Not supported (partial support expected in 10.0)<br/>");document.writeln(" - Safari: Not supported<br/>");document.writeln(" - Opera: Not supported");
return!1}function handleFileSelect(a){a=a.target.files[0];var b;b="Data Loaded!<br/>"+(" - FileName: "+escape(a.name)+"<br/>");b+=" - FileType: "+(a.type||"n/a")+"<br/>";b+=" - FileSize: "+a.size+" bytes<br/>";b+=" - LastModified: "+(a.lastModifiedDate?a.lastModifiedDate.toLocaleDateString():"n/a")+"<br/>";readData(a);$("#upload_status").html(b);d3.select("svg").remove()}
function readData(a){var b=new FileReader;b.readAsText(a);b.onload=function(a){rawDataObject.dataObject=$.csv.toObjects(a.target.result);defineX(Object.keys(rawDataObject.dataObject[0]));defineY(Object.keys(rawDataObject.dataObject[0]));defineTooltip(Object.keys(rawDataObject.dataObject[0]));createCheckBox(rawDataObject.dataObject)};b.onerror=function(){alert("Unable to read "+a.fileName)}}
function defineX(a){$("#choose_x").empty();$("#choose_x").append("<option value=''>choose variable x</option>");for(var b=a.length,c=0;c<b;c++)if(-1==$.inArray(a[c].toLowerCase().substring(0,6),rawDataObject.hideList)){var d=document.createElement("option");d.text="x: "+a[c];d.value=a[c];document.getElementById("choose_x").options.add(d)}$("#choose_x").show()}
function defineY(a){$("#choose_y").empty();$("#choose_y").append("<option value=''>choose variable y</option>");for(var b=a.length,c=0;c<b;c++)if(-1==$.inArray(a[c].toLowerCase().substring(0,6),rawDataObject.hideList)){var d=document.createElement("option");d.text="y: "+a[c];d.value=a[c];document.getElementById("choose_y").options.add(d)}$("#choose_y").show()}
function defineTooltip(a){$(".tooltip_display").remove();$("#tooltip_title").show();for(var b=0;b<a.length;b++)if(-1==$.inArray(a[b].toLowerCase().substring(0,6),rawDataObject.hideList)){var c=$("<label/>").html(a[b]).prepend($("<input/>").attr({type:"checkbox",id:a[b],"class":"tooltip_display",value:a[b]}));$("#tooltip_checkbox").append(c).append("<br/>")}$("#selectall_label").show();$("#tooltip_selectall").show()}
function selectAll(a){for(var b=$(".tooltip_display"),c=0;c<b.length;c++)b[c].checked=a.checked}function defineFilters(a){for(var b=a.length,c=[],d=0;d<b;d++)"filter"==a[d].toLowerCase().substring(0,6)&&c.push(a[d]);return c}
function createCheckBox(a){$("#filter_checkbox").empty();for(var b=Object.keys(a[0]),b=defineFilters(b),c=0;c<b.length;c++){$("#filter_checkbox").append("<br/>");$("#filter_checkbox").append("<div class="+b[c].substr(9)+"><b>"+b[c]+"</b></div>");for(var d=[],e=0;e<a.length;e++)-1==$.inArray(a[e][b[c]],d)&&d.push(a[e][b[c]]);isNaN(parseFloat(d[0]))?d.sort():d.sort(sortNumber);for(e=0;e<d.length;e++){var h=$("<label/>").html(d[e]).prepend($("<input/>").attr({type:"checkbox",id:b[c],"class":"checkbox",
value:d[e]}));$("#filter_checkbox").append(h).append("<br/>")}}}
function subsetData(a){$("#upload_status").html("");for(var b={},c=0;c<$(".checkbox").length;c++)!1==$(".checkbox")[c].checked&&($(".checkbox")[c].id in b||(b[$(".checkbox")[c].id]=[]),b[$(".checkbox")[c].id].push($(".checkbox")[c].value));a=a.slice();for(var d=0,c=a.length-1;0<=c;c--){var d=0,e;for(e in b)-1<$.inArray(a[c][e],b[e])&&(d+=1);0<d&&a.splice(c,1)}for(c=0;c<a.length;c++)for(e in a[c].Category="",a[c])"filter"==e.toLowerCase().substring(0,6)&&(a[c].Category=a[c].Category+a[c][e]+"; ");
return a}
function scatterPlot(a){var b=rawDataObject.margin,c=rawDataObject.width,d=rawDataObject.height,e=rawDataObject.settings,h=e.xName,f=e.yName,l=e.zName,m=e.xMax,k=e.yMin,r=e.yMax,p=e.minimumX;maximumX=e.maximumX;var e=function(a){return a[h]},n=d3.scale.log().domain([p-.1*p,m+.1*m]).range([0,c]).nice(),m=d3.svg.axis().scale(n).orient("bottom").tickValues([100,1E3,1E4,1E5,1E6,1E7,1E8]).tickFormat(d3.format(",")),g=d3.scale.linear().domain([k-.1*k,r+.15*r]).range([d,0]).nice(),k=d3.svg.axis().scale(g).orient("left"),q=
d3.scale.category10();rawDataObject.xScale=n;rawDataObject.yScale=g;d3.select("#data_visualization").append("div").attr("id","div_click_tooltip");b=d3.select("#data_visualization").append("svg").attr("width",$("#data_visualization").width()-20).attr("height",d+b.top+b.bottom).append("g").attr("transform","translate("+b.left+","+b.top+")");b.append("g").attr("class","axis").attr("transform","translate(0,"+d+")").call(m).append("text").attr("class","label").attr("x",c+25).attr("y",40).style("text-anchor",
"end").style("font-weight","bold").text(h);b.append("g").attr("class","axis").call(k).append("text").attr("class","label").attr("x",25).attr("y",-20).style("text-anchor","end").style("font-weight","bold").text(f);b.append("g").attr("class","scatterplot").selectAll("scatterplot").data(a).enter().append("circle").attr("class","dot").attr("r",4.5).attr("cx",function(a){return n(a[h])}).attr("cy",function(a){return g(a[f])}).style("fill",function(a){return q(a[l])}).style("z-index",8).on("click",tooltipClick).on("mouseover",
tooltipMouseover).on("mouseout",tooltipMouseout);c=b.selectAll(".legend").data(q.domain()).enter().append("g").style("z-index",1).attr("class","legend").attr("transform",function(a,b){return"translate(0,"+20*b+")"});c.append("rect").attr("x",1.05*n(d3.max(a,e))).attr("y",-12).attr("width",18).attr("height",18).attr("fill",q);c.append("text").attr("x",1.05*n(d3.max(a,e))+20).attr("y",0).style("text-anchor","start").text(function(a){return a})}
function addLine(a){var b=rawDataObject.anchorName,c=rawDataObject.dSlopeName,d=rawDataObject.minPriceX,e=rawDataObject.xScale,h=rawDataObject.yScale,f=rawDataObject.settings,l=f.yName,m=f.zName,f=f.maximumX;lineVals=[];for(var k=0;k<a.length;k++)if(-1==$.inArray(a[k][m],extractValue(lineVals,"category"))){var r={category:a[k][m],dSlope:parseFloat(a[k][c]),anchorX:parseFloat(a[k][b.x]),anchorY:0,anchorYpx:parseFloat(a[k][b.y]),anchorYperGB:parseFloat(a[k].AnchorPerGB),intercept:0};lineVals.push(r)}a=
d3.scale.category10().domain([0,1,2,3,4,5,6,7,8,9]);d3.select("#data_visualization").append("div").attr("id","line_tooltip").attr("class","tooltip");b=[];for(k=0;k<lineVals.length;k++){lineVals[k].anchorY=l==rawDataObject.pxGB?lineVals[k].anchorYperGB:lineVals[k].anchorYpx;var p=findLine(lineVals[k].dSlope*lineVals[k].anchorY,log10(d),log10(lineVals[k].anchorX),lineVals[k].anchorY,log10(1.1*f));lineVals[k].intercept=p.intercept;p.fillName="group_"+k;p.category=lineVals[k].category;b.push(p);d3.select("g").attr("class",
"gridline").append("svg:line").attr("id","line_"+k).attr("class","grid_line").attr("x1",e(Math.pow(10,p.x1))).attr("y1",h(p.y1)).attr("x2",e(1.1*f)).attr("y2",h(p.y2Max)).style("stroke",a(k)).style("stroke-width",6).style("opacity",.62).style("z-index",6).on("click",function(a){$(".externalObject").remove();a=""+("<div id=new_slope_text class=externalTextbox><b>Current Discount Slope: "+p.slope/p.y2+"</b></div>");a+="<input type='text' id=new_slope class=externalTextbox placeholder='enter new discount slope' onchange=updateLine()></input>";
d3.select("svg").append("foreignObject").attr("class","externalObject").attr("x",d3.mouse(this)[0]-20+"px").attr("y",d3.mouse(this)[1]-10+"px").attr("width",200).attr("height",100).append("xhtml:div").html(a)})}rawDataObject.pointData=b}
function addAnchorPoints(){var a=rawDataObject.pointData,b=rawDataObject.xScale,c=rawDataObject.yScale,d=rawDataObject.settings,e=d.xName,h=d.yName,f=d3.scale.category10().domain([0,1,2,3,4,5,6,7,8,9]),l=d3.format(",f"),m=d3.select("#data_visualization").append("div").attr("id","anchor_tooltip").attr("class","tooltip");d3.select("g").append("g").attr("class","anchorpoints").selectAll("anchorpoints").data(a).enter().append("circle").attr("id",function(a){return"anchor_"+a.fillName}).attr("class","anchor_point").attr("r",
6).attr("cx",function(a){return b(Math.pow(10,a.x2))}).attr("cy",function(a){return c(a.y2)}).style("fill",function(a){return f(a.fillName)}).style("stroke","black").style("stroke-width","2px").style("stroke-opacity",.38).style("opacity",.38).style("z-index",8).on("mouseover",function(a){a="<u>Anchor Point</u><br/>"+e+": "+l(Math.pow(10,a.x2))+"<br/>"+h+": "+a.y2.toFixed(2);m.transition().style("opacity",.62);m.html(a).style("left",d3.event.pageX-80+"px").style("top",d3.event.pageY+20+"px")}).on("mouseout",
function(a){m.transition().style("opacity",0)}).on("click",function(a){d3.select(this).transition().style("stroke-opacity",1).style("opacity",1);$(".externalObject").remove();a="<div id=new_anchor_text class=externalTextbox><b>Current Coordinates:<br/>"+("("+l(Math.pow(10,a.x2))+", "+a.y2.toFixed(2)+")</b></div>");a+="<input type='text' id=new_anchor class=externalTextbox placeholder='enter new coordinates' onchange=updateAnchor()></input>";rawDataObject.selectedAnchorId=d3.select(this).attr("id");
d3.select("svg").append("foreignObject").attr("class","externalObject").attr("x",d3.mouse(this)[0]-20+"px").attr("y",d3.mouse(this)[1]-15+"px").attr("width",200).attr("height",100).append("xhtml:div").html(a)})}
function addMinPricePoint(){var a=rawDataObject.pointData,b=rawDataObject.xScale,c=rawDataObject.yScale,d=rawDataObject.settings,e=d.xName,h=d.yName,f=d3.scale.category10().domain([0,1,2,3,4,5,6,7,8,9]),l=d3.format(",f"),m=d3.select("#data_visualization").append("div").attr("id","min_price_tooltip").attr("class","tooltip");d3.select("g").append("g").attr("class","minpricepoints").selectAll("minpricepoints").data(a).enter().append("circle").attr("id",function(a){return"minx_"+a.fillName}).attr("class",
"min_price_point").attr("r",6).attr("cx",function(a){return b(Math.pow(10,a.x1))}).attr("cy",function(a){return c(a.y1)}).style("fill",function(a){return f(a.fillName)}).style("stroke","black").style("stroke-width","2px").style("stroke-opacity",.38).style("opacity",.38).style("z-index",7).on("mouseover",function(a){a="<u>Minimum Price Point</u><br/>"+e+": "+l(rawDataObject.minPriceX)+"<br/>"+h+": "+a.y1.toFixed(2);m.transition().style("opacity",.62);m.html(a).style("left",d3.event.pageX-80+"px").style("top",
d3.event.pageY+20+"px")}).on("mouseout",function(a){m.transition().style("opacity",0)}).on("click",function(a){d3.select(this).transition().style("stroke-opacity",1).style("opacity",1);$(".externalObject").remove();a="<div id=new_minx_text class=externalTextbox><b>Current Minimum Price:<br/>"+(l(rawDataObject.minPriceX)+"</b></div>");a+="<input type='text' id=new_minx class=externalTextbox placeholder='enter new minimum price' onchange=updateMinX()></input>";d3.select("svg").append("foreignObject").attr("class",
"externalObject").attr("x",d3.mouse(this)[0]-20+"px").attr("y",d3.mouse(this)[1]-15+"px").attr("width",200).attr("height",100).append("xhtml:div").html(a)});for(d=0;d<a.length;d++)d3.select("g").attr("class","hline").append("svg:line").attr("id","hline_"+d).attr("class","hline").attr("x1",0).attr("y1",c(a[d].y1)).attr("x2",b(Math.pow(10,a[d].x1))).attr("y2",c(a[d].y1)).style("stroke",f(d)).style("stroke-width",6).style("opacity",.62).style("z-index",7)}
function updateLine(){for(var a=rawDataObject.currentData,b=rawDataObject.pointData,c=rawDataObject.updateField,d=rawDataObject.dSlopeName,e=rawDataObject.capacityName,h=rawDataObject.xScale,f=rawDataObject.yScale,l=rawDataObject.settings,m=rawDataObject.minPriceX,k=l.xName,r=l.yName,p=l.maximumX,l=0,n=a.slice(),l="undefined"==typeof $("#new_slope").val()?a[0][d]:parseFloat($("#new_slope").val()),g=0;g<b.length;g++){var q=findLine(l*b[g].y2,log10(m),b[g].x2,b[g].y2,log10(1.1*p)),s=q.intercept+q.slope*
q.x1;b[g].y1=s;b[g].intercept=q.intercept;b[g].slope=q.slope;d3.select("#line_"+g).transition().attr("x1",h(m)).attr("y1",f(s)).attr("x2",h(1.1*p)).attr("y2",f(q.y2Max));d3.select("#minx_group_"+g).transition().attr("cx",h(m)).attr("cy",f(s)).style("stroke-opacity",.38).style("opacity",.38);d3.select("#hline_"+g).transition().attr("x1",0).attr("y1",f(s)).attr("x2",h(m)).attr("y2",f(s))}$("#new_slope").hide();$("#new_slope_text").hide();for(g=0;g<a.length;g++)for(h=0;h<b.length;h++)a[g].Category==
b[h].category&&(r==rawDataObject.pxGB?(a[g][c[1]]=b[h].intercept+b[h].slope*log10(n[g][k]),a[g][c[0]]=n[g][c[1]]*parseInt(n[g][e]),a[g][c[2]]=(n[g][r]-n[g][c[1]])/n[g][c[1]]):(a[g][c[0]]=b[h].intercept+b[h].slope*log10(n[g][k]),a[g][c[1]]=n[g][c[0]]/parseInt(a[g][e]),a[g][c[2]]=(n[g][r]-n[g][c[0]])/n[g][c[0]]),a[g][d]=l)}
function updateAnchor(){d3.selectAll("#anchor_tooltip").style("opacity",0);for(var a=rawDataObject.selectedAnchorId,b=rawDataObject.currentData,c=rawDataObject.pointData,d=rawDataObject.xScale,e=rawDataObject.yScale,h=rawDataObject.anchorName,f=rawDataObject.settings.xMax,l=$("#new_anchor").val().split(","),m=parseFloat(l[0]),k=parseFloat(l[1]),l=0;l<c.length;l++)c[l].fillName==rawDataObject.selectedAnchorId.substr(7)&&(c[l].x2=log10(m),c[l].y2=k);d3.select("#"+a).transition().attr("cx",d(m)).attr("cy",
e(k)).style("stroke-opacity",.38).style("opacity",.38);$("#new_anchor").hide();$("#new_anchor_text").hide();a=Math.pow(10,d3.max(extractValue(c,"x2")));Math.round(Math.max(f,a))>=m?rawDataObject.settings.maximumX=Math.round(Math.max(f,a)):rawDataObject.settings.maximumX=f;for(l=0;l<b.length;l++)for(f=0;f<c.length;f++)b[l].Category==c[f].category&&(b[l][h.x]=Math.pow(10,c[f].x2),b[l][h.y]=c[f].y2);updateLine()}
function updateMinX(){d3.selectAll("#min_price_tooltip").style("opacity",0);var a=parseInt($("#new_minx").val());rawDataObject.minPriceX=a;updateLine();$("#new_minx").hide();$("#new_minx_text").hide()}function tooltipMouseover(a){$("#div_tooltip").remove();var b=d3.select("#data_visualization").append("div").attr("id","div_tooltip").attr("class","tooltip");a=tooltipUpdate(a);b.transition().style("opacity",.62);b.html(a).style("left",d3.event.pageX+20+"px").style("top",d3.event.pageY-40+"px")}
function tooltipMouseout(a){d3.select("#div_tooltip").transition().style("opacity",0)}
function tooltipClick(a){var b="point_"+d3.select(this).attr("cx").replace(".","_")+"_"+d3.select(this).attr("cy").replace(".","_"),c=d3.select("#div_click_tooltip").append("div").attr("id",b).attr("class","click_tooltip");8>d3.select(this).attr("r")?(a=tooltipUpdate(a),d3.select(this).attr("r",60).style("stroke","black").style("stroke-width","2px").style("stroke-opacity",1).transition().duration(600).attr("r",8),c.transition().style("opacity",.62),c.html(a).style("left",d3.event.pageX+20+"px").style("top",
d3.event.pageY-40+"px")):(d3.select(this).transition().attr("r",4.5).style("stroke-opacity",0),d3.selectAll("#"+b).transition().style("opacity",0).remove())}function tooltipUpdate(a){for(var b="",c="",d=d3.format(".2f"),e=d3.format(",f"),h=0;h<$(".tooltip_display").length;h++)!0==$(".tooltip_display")[h].checked&&(c=$(".tooltip_display")[h].value,b=!isNaN(a[c])&&1E3<=a[c]?b+(c+": "+e(a[c])+"<br/>"):!isNaN(a[c])&&1E3>a[c]?b+(c+": "+d(a[c])+"<br/>"):b+(c+": "+a[c]+"<br/>"));return b}
function printGrid(a){a=$("#data_visualization").html();var b=window.open();$(b.document.body).html(a);b.print();b.close()}function logOutput(){for(var a=rawDataObject.currentData,b=0;b<a.length;b++){var c=[],d;for(d in a[b])"Category"!=d&&"AnchorPerGB"!=d&&c.push(a[b][d]);rawDataObject.userLog=rawDataObject.userLog.concat(c.toString()+"\n")}$("#log_status").html("Data Saved!").show();setTimeout(function(){$("#log_status").fadeOut("slow")},800)}
function exportToText(){var a=new Blob([rawDataObject.userLog],{type:"text/html",endings:"native"}),b=document.createElement("a");b.download="UpdatedData.csv";null!=window.webkitURL?b.href=window.webkitURL.createObjectURL(a):(b.href=window.URL.createObjectURL(a),b.onclick=function(a){document.body.removeChild(a.target)},b.style.display="none",document.body.appendChild(b));b.click()}
function initPlot(){d3.selectAll("svg").remove();d3.selectAll(".tooltip").remove();d3.selectAll("#div_click_tooltip").remove();$("#upload_status").html("");$(document).mouseup(function(a){var b=$(".externalTextbox");b.is(a.target)||0!==b.has(a.target).length||(b.hide(),d3.selectAll(".anchor_point").transition().style("stroke-opacity",.38).style("opacity",.38),d3.selectAll(".min_price_point").transition().style("stroke-opacity",.38).style("opacity",.38))});rawDataObject.currentData=subsetData(rawDataObject.dataObject);
if(""==$("#choose_x").val()||""==$("#choose_y").val())alert("Axis not defined!");else if("undefined"==typeof rawDataObject.currentData||0==rawDataObject.currentData.length)$("#error_display").html("<font color='red'>Insufficient data, check more filters!</font>").show(),setTimeout(function(){$("#error_display").fadeOut("slow")},500);else{var a=rawDataObject.currentData,b={};b.xName=$("#choose_x").val();b.yName=$("#choose_y").val();b.zName="Category";a.forEach(function(a){a[b.xName]=+a[b.xName];a[b.yName]=
+a[b.yName];a[rawDataObject.anchorName.x]=+a[rawDataObject.anchorName.x];a[rawDataObject.anchorName.y]=+a[rawDataObject.anchorName.y];b.yName==rawDataObject.pxGB&&(a.AnchorPerGB=a[rawDataObject.anchorName.y]/a[rawDataObject.capacityName])});b.xMin=d3.min(extractValue(a,b.xName));b.xMax=d3.max(extractValue(a,b.xName));b.yMin=d3.min(extractValue(a,b.yName));b.yMax=d3.max(extractValue(a,b.yName));b.minimumX=Math.min(b.xMin,rawDataObject.minPriceX);b.maximumX=Math.max(b.xMax,d3.max(extractValue(a,rawDataObject.anchorName.x)));
rawDataObject.settings=b;scatterPlot(a);addLine(a);addAnchorPoints();addMinPricePoint();""==rawDataObject.userLog&&0<d3.selectAll(".dot")[0].length&&(a=Object.keys(a[0]),a.splice(a.indexOf("Category")),rawDataObject.userLog=a.toString().concat("\n"))}};